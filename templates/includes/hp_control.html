<div class="hp-control card">
    <h3 class="hp-title">Управление здоровьем</h3>

    <div class="hp-display">
        <span class="hp-label">Текущие HP:</span>
        <strong id="hp-current" class="hp-value">{{ char.current_hp }}</strong>
        <span class="hp-separator">/</span>
        <span id="hp-max" class="hp-max">{{ char.max_hp }}</span>
    </div>

    <div class="hp-adjust">
        <div class="hp-quick-controls">
            <button class="hp-btn hp-decrease" data-delta="-5">-5</button>
            <button class="hp-btn hp-decrease" data-delta="-1">-1</button>

            <input type="number" id="hp-delta" class="hp-input" value="1" step="1">

            <button class="hp-btn hp-increase" data-delta="+1">+1</button>
            <button class="hp-btn hp-increase" data-delta="+5">+5</button>

            <button id="hp-apply-btn" class="hp-apply-btn">Применить</button>
        </div>

        <div class="hp-special-actions">
            <button class="hp-special-btn hp-min-btn" data-action="min">Установить 0</button>
            <button class="hp-special-btn hp-heal-btn" data-action="heal">Полное лечение</button>
            <button class="hp-special-btn hp-half-btn" data-action="half">50% </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const url = "{% url 'characters:ajax_adjust_hp' char.id %}";
        let maxHp = parseInt(document.getElementById("hp-max").textContent);
        let currentHp = parseInt(document.getElementById("hp-current").textContent);

        function getCookie(name) {
            let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? v.pop() : '';
        }

        const csrfToken = getCookie('csrftoken');
        const deltaInput = document.getElementById("hp-delta");
        const currentEl = document.getElementById("hp-current");

        async function changeHp(delta) {
            if (isNaN(delta)) return;

            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                        "X-Requested-With": "XMLHttpRequest",
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({delta: delta.toString()})
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const json = await res.json();
                if (json.status === "ok") {
                    currentHp = json.current_hp;
                    currentEl.textContent = currentHp;

                    // Визуальный эффект
                    const effectClass = delta > 0 ? 'hp-heal-effect' : 'hp-damage-effect';
                    currentEl.classList.add(effectClass);
                    setTimeout(() => currentEl.classList.remove(effectClass), 500);
                } else {
                    alert("Ошибка: " + json.message);
                }
            } catch (err) {
                console.error(err);
                alert("Не удалось изменить HP");
            }
        }

        async function setHp(value) {
            const delta = value - currentHp;
            await changeHp(delta);
        }

        // Обработчики для кнопок быстрого изменения
        document.querySelectorAll('.hp-btn[data-delta]').forEach(btn => {
            btn.addEventListener('click', async () => {
                let delta = parseInt(btn.dataset.delta);
                await changeHp(delta);
            });
        });

        // Обработчик для кнопки Применить
        document.getElementById("hp-apply-btn").addEventListener("click", async () => {
            const delta = parseInt(deltaInput.value);
            if (isNaN(delta)) {
                alert("Пожалуйста, введите число");
                return;
            }
            await changeHp(delta);
        });

        // Обработчики для специальных кнопок
        document.querySelectorAll('.hp-special-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const action = btn.dataset.action;

                if (action === 'heal') {
                    await setHp(maxHp);
                }
                else if (action === 'min') {
                    await setHp(0);
                }
                else if (action === 'half') {
                    await setHp(Math.floor(maxHp / 2));
                }
            });
        });

        // Проверка ввода вручную
        deltaInput.addEventListener('change', () => {
            let value = parseInt(deltaInput.value);
            if (isNaN(value)) {
                deltaInput.value = 0;
            }
        });
    });
</script>

<style>
    .hp-control {
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        background: var(--card-bg);
        border: 1px solid var(--border);
    }
    .hp-title {
        font-family: "Beleren", "Cinzel", serif;
        font-size: 1.5rem;
        color: var(--accent);
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.5rem;
    }
    .hp-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.25rem;
        font-family: "Cormorant Garamond", serif;
        font-size: 1.25rem;
    }
    .hp-label { color: var(--text); }
    .hp-value { color: var(--accent); font-size: 1.5rem; min-width: 2.5rem; text-align: center; }
    .hp-separator { color: var(--accent-dark); }
    .hp-max { color: #ccc; }
    .hp-adjust { display: flex; flex-direction: column; gap: 1rem; }
    .hp-quick-controls { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .hp-input {
        width: 4rem;
        padding: 0.5rem;
        text-align: center;
        font-family: "Cormorant Garamond", serif;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg);
        color: var(--text);
    }
    .hp-btn {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--accent);
        border-radius: 4px;
        font-family: "Cormorant Garamond", serif;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--accent);
        color:#000;
    }
    .hp-decrease { background: var(--accent-red); border-color: #512030; color:#fff; }
    .hp-decrease:hover { background: #551d33; }
    .hp-increase { background: #a5d6a7; border-color:#81c784; }
    .hp-increase:hover { background: #81c784; }
    .hp-apply-btn {
        padding: 0.5rem 1rem;
        background: var(--accent);
        color:#000;
        border: 1px solid var(--accent-dark);
        border-radius: 4px;
        font-family: "Cormorant Garamond", serif;
        cursor: pointer;
        transition: background 0.2s;
    }
    .hp-apply-btn:hover { background: var(--accent-dark); }
    .hp-special-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .hp-special-btn {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-family: "Cormorant Garamond", serif;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        color:#000;
    }
    .hp-min-btn { background: var(--accent-red); color:#fff; border-color: #512030; }
    .hp-min-btn:hover { background: #551d33; }
    .hp-heal-btn { background: #a5d6a7; color:#000; border-color: #81c784; font-weight: bold; }
    .hp-heal-btn:hover { background: #81c784; }
    .hp-half-btn { background: #90caf9; color:#000; border-color: #64b5f6; }
    .hp-half-btn:hover { background: #64b5f6; }
    .hp-heal-effect { color: #2e7d32; font-weight: bold; animation: hp-pulse-green 0.5s; }
    .hp-damage-effect { color: var(--accent-red); font-weight: bold; animation: hp-pulse-red 0.5s; }
    @keyframes hp-pulse-green { 0% { color: #2e7d32; transform: scale(1); } 50% { color: #4caf50; transform: scale(1.1); } 100% { color: #2e7d32; transform: scale(1); } }
    @keyframes hp-pulse-red { 0% { color: var(--accent-red); transform: scale(1); } 50% { color: #a83e62; transform: scale(1.1); } 100% { color: var(--accent-red); transform: scale(1); } }
    @media (max-width: 600px) {
        .hp-quick-controls { flex-direction: column; align-items: stretch; }
        .hp-input, .hp-btn, .hp-apply-btn { width: 100%; }
        .hp-special-actions { flex-direction: column; }
    }
</style>
