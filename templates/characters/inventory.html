{% extends "base.html" %}
{% load static %}
{% load inventory_tags %}

{% block title %}Инвентарь персонажа: {{ char.name }}{% endblock %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}


{% block content %}
    <h1>Инвентарь: <a href="{% url 'characters:character_detail' char.id %}">{{ char.name }}</a></h1>
    <p><strong>Соллиды:</strong> <span id="char-gold">{{ char.gold }} Ꞩ</span></p>
    <p><strong>Нагрузка:</strong> <span id="char-gold">{{ char.get_current_load.total_weight }} / {{ char.get_current_load.carry_capacity }} кг</span></p>
{#    <p>{{ char.get_current_load }}</p>#}

    <div class="inventory-layout"
         data-char-id="{{ char.id }}"
         data-equip-base="{% url 'characters:equip-item' char.id 0 %}"
         data-drop-base="{% url 'characters:drop-item' char.id 0 %}"
         data-unequip-base="{% url 'characters:unequip-slot' char.id 'SLOT'|slice:":-1" %}"
         data-sell-base="{% if char.can_trade %}{% url 'shops:ajax-sell-item' char.id 0 %}{% endif %}"
         data-storage-store-base="{% url 'characters:home-storage-store' char.id 0 %}"
         data-storage-retrieve-base="{% url 'characters:home-storage-retrieve' char.id 0 %}"
         data-storage-delete-base="{% url 'characters:home-storage-delete' char.id 0 %}"
         data-can-trade="{{ char.can_trade|yesno:'true,false' }}"
         data-can-use-storage="{{ can_use_home_storage|yesno:'true,false' }}">


        <!-- Экипировка -->
        <div class="inventory-section">
            <h2>Экипировка</h2>
            <table class="item-table" id="equip-table">
                <thead>
                <tr>
                    <th>Слот</th>
                    <th>Предмет</th>
                    <th>Бонус</th>
                    <th>Вес</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for slot_dict in slot_names %}
                    {% for slot,label in slot_dict.items %}
                        {% with item=equipment|get_attr:slot %}
                            <tr class="equip-row"
                                data-slot="{{ slot }}"
                                data-label="{{ label }}"
                                    {% if item %}
                                data-unequip-url="{% url 'characters:unequip-slot' char.id slot %}"
                                    {% endif %}>
                                <td>{{ label }}</td>
                                {% if item %}
                                    <td>{{ item.name }}</td>
                                    <td>+{{ item.bonus }}</td>
                                    <td>{{ item.weight }} кг</td>
                                    <td>
                                        <form class="unequip-form">
                                            {% csrf_token %}
                                            <button class="btn-inventory btn-unequip">Снять</button>
                                        </form>
                                    </td>
                                {% else %}
                                    <td colspan="4" class="empty-slot">Пусто</td>
                                {% endif %}
                            </tr>
                        {% endwith %}
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Инвентарь -->
        <div class="inventory-section">
            <h2>Инвентарь</h2>
            <table class="item-table" id="inv-table">
                <thead>
                <tr>
                    <th>Название</th>
                    <th>Кол-во</th>
                    <th>Бонус</th>
                    <th>Вес</th>
                    <th>Легендарный бaф</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                {% for entry in inventory_items %}
                    <tr class="inv-row"
                        data-item-id="{{ entry.item.id }}">
                        <td class="name-cell"><span
                                style="border-left: 6px solid {{ entry.item.rarity.color }}; padding-left: 6px">{{ entry.item.name }}</span>
                        </td>
                        <td class="quantity-cell">{{ entry.quantity }}</td>
                        <td class="bonus-cell">+{{ entry.item.bonus }}</td>
                        <td class="weight-cell">{{ entry.item.weight }} кг</td>
                        <td class="legendary-cell">
                            {% if entry.item.legendary_buff %}{{ entry.item.legendary_buff }}{% else %}—{% endif %}
                        </td>
                        <td class="td-buttons">
                             {% if char.can_trade %}
                    <button
                            class="btn-inventory btn-sell"
                            data-sell-url="{% url 'shops:ajax-sell-item' char.id entry.item.id %}">
                        Продать ({{ entry.item|sell_price_for:char }}Ꞩ)
                    </button>
                {% endif %}
                            <form class="equip-form">
                                {% csrf_token %}
                                <button class="btn-inventory btn-equip">Экипировать</button>
                            </form>
                            <form class="drop-form">
                                {% csrf_token %}
                                <button class="btn-inventory btn-drop">Выбросить</button>
                            </form>
                            {% if can_use_home_storage %}
                                <form class="storage-form" method="post"
                                      data-storage-action="store"
                                      data-item-id="{{ entry.item.id }}"
                                      action="{% url 'characters:home-storage-store' char.id entry.item.id %}">
                                    {% csrf_token %}
                                    <input id="store-quantity-{{ entry.item.id }}" type="number" name="quantity" min="1"
                                           max="{{ entry.quantity }}" value="1" class="storage-quantity-input"
                                           aria-label="Количество">
                                    <button class="btn-inventory btn-store">В хранилище</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="empty-slot">Инвентарь пуст.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {# Шаблон строки для динамического добавления в инвентарь #}
    <template id="inv-row-template">
        <tr class="inv-row" data-item-id="">
            <td class="name-cell"></td>
            <td class="quantity-cell"></td>
            <td class="bonus-cell"></td>
            <td class="weight-cell"></td>
            <td class="legendary-cell"></td>
            <td class="td-buttons">

                <form class="equip-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <button class="btn-inventory btn-equip">Экипировать</button>
                </form>
                <form class="drop-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <button class="btn-inventory btn-drop">Выбросить</button>
                </form>
            </td>
        </tr>
    </template>
    <template id="storage-row-template">
        <tr class="storage-row" data-item-id="">
            <td class="name-cell"></td>
            <td class="quantity-cell"></td>
            <td class="bonus-cell"></td>
            <td class="weight-cell"></td>
            <td class="legendary-cell"></td>
            <td class="td-buttons">
                <div class="storage-actions">
                    <form class="storage-form" method="post" data-storage-action="retrieve" data-item-id="">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="number" name="quantity" min="1" value="1" class="storage-quantity-input" aria-label="Количество">
                        <button class="btn-inventory btn-store">Забрать</button>
                    </form>
                    <form class="storage-form" method="post" data-storage-action="delete" data-item-id="">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="number" name="quantity" min="1" value="1" class="storage-quantity-input" aria-label="Количество">
                        <button class="btn-inventory btn-drop">Удалить</button>
                    </form>
                </div>
            </td>
        </tr>
    </template>
    <div class="home-storage-controls">
        {% if can_toggle_home_storage %}
            <form method="post" action="{% url 'characters:home-storage-toggle' char.id %}">
                {% csrf_token %}
                {% if home_storage_enabled %}
                    <button class="btn">Отключить домашнее хранилище</button>
                {% else %}
                    <button class="btn">Разрешить домашнее хранилище</button>
                {% endif %}
            </form>
        {% endif %}
    </div>

    {% if home_storage_enabled %}
        <div class="inventory-section home-storage">
            <h2>Домашнее хранилище</h2>
            <table class="item-table home-storage-table">
                <thead>
                <tr>
                    <th>Название</th>
                    <th>Кол-во</th>
                    <th>Бонус</th>
                    <th>Вес</th>
                    <th>Легендарный баф</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                {% if home_storage_items %}
                    {% for entry in home_storage_items %}
                        <tr class="storage-row" data-item-id="{{ entry.item.id }}">
                            <td class="name-cell"><span
                                    style="border-left: 6px solid {{ entry.item.rarity.color }}; padding-left: 6px">{{ entry.item.name }}</span>
                            </td>
                            <td class="quantity-cell">{{ entry.quantity }}</td>
                            <td class="bonus-cell">+{{ entry.item.bonus }}</td>
                            <td class="weight-cell">{{ entry.item.weight }} кг</td>
                            <td class="legendary-cell">
                                {% if entry.item.legendary_buff %}{{ entry.item.legendary_buff }}{% else %}—{% endif %}
                            </td>
                            <td class="td-buttons">
                                {% if can_use_home_storage %}
                                    <div class="storage-actions">
                                        <form class="storage-form" method="post"
                                              data-storage-action="retrieve"
                                              data-item-id="{{ entry.item.id }}"
                                              action="{% url 'characters:home-storage-retrieve' char.id entry.item.id %}">
                                            {% csrf_token %}
                                            <input id="retrieve-quantity-{{ entry.item.id }}" type="number" name="quantity"
                                                   min="1" max="{{ entry.quantity }}" value="1"
                                                   class="storage-quantity-input" aria-label="Количество">
                                            <button class="btn-inventory btn-store">Забрать</button>
                                        </form>
                                        <form class="storage-form" method="post"
                                              data-storage-action="delete"
                                              data-item-id="{{ entry.item.id }}"
                                              action="{% url 'characters:home-storage-delete' char.id entry.item.id %}">
                                            {% csrf_token %}
                                            <input id="delete-quantity-{{ entry.item.id }}" type="number" name="quantity"
                                                   min="1" max="{{ entry.quantity }}" value="{{ entry.quantity }}"
                                                   class="storage-quantity-input" aria-label="Количество">
                                            <button class="btn-inventory btn-drop">Удалить</button>
                                        </form>
                                    </div>
                                {% else %}
                                    <span class="text-muted">Недоступно</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                        <tr class="empty-row" data-empty="storage">
                            <td colspan="6" class="empty-slot">Хранилище пусто.</td>
                        </tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    {% else %}
        {% if can_toggle_home_storage %}
            <p class="text-muted">Домашнее хранилище сейчас отключено.</p>
        {% endif %}
    {% endif %}
    <h2>Сундуки</h2>
    {% if char.chests.exists %}
        {% for chest in char.chests.all %}
            <div class="card">
                <h4>{{ chest.config.name }} <small>от {{ chest.created_at|date:"SHORT_DATETIME_FORMAT" }}</small></h4>
                <a href="{% url 'characters:chest-detail' chest.id %}" class="btn">Подробнее <img
                        src="{% static 'img/arrow-right.svg' %}"></a>
            </div>
        {% endfor %}
    {% else %}
        <p>У вас нет текущих сундуков.</p>
    {% endif %}

{% endblock %}

{% block js %}
    <script src="{% static 'js/character_inventory.js' %}"></script>
{% endblock %}

