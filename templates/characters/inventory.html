{% extends "base.html" %}
{% load static %}
{% load inventory_tags %}

{% block title %}Инвентарь персонажа: {{ char.name }}{% endblock %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}


{% block content %}
    <h1>Инвентарь: <a href="{% url 'characters:character_detail' char.id %}">{{ char.name }}</a></h1>
    <p><strong>Соллиды:</strong> <span id="char-gold">{{ char.gold }} Ꞩ</span></p>
    <p><strong>Нагрузка:</strong> <span
            id="char-load">{{ char.get_current_load.total_weight }} / {{ char.get_current_load.carry_capacity }} кг</span>
    </p>
    {#    <p>{{ char.get_current_load }}</p>#}

    <div class="inventory-layout"
         data-char-id="{{ char.id }}"
         data-equip-base="{% url 'characters:equip-item' char.id 0 %}"
         data-drop-base="{% url 'characters:drop-item' char.id 0 %}"
         data-unequip-base="{% url 'characters:unequip-slot' char.id 'SLOT'|slice:":-1" %}"
         data-sell-base="{% if char.can_trade %}{% url 'shops:ajax-sell-item' char.id 0 %}{% endif %}"
         data-storage-store-base="{% url 'characters:home-storage-store' char.id 0 %}"
         data-storage-retrieve-base="{% url 'characters:home-storage-retrieve' char.id 0 %}"
            {#         data-storage-delete-base="{% url 'characters:home-storage-delete' char.id 0 %}"#}
         data-can-trade="{{ char.can_trade|yesno:'true,false' }}"
         data-can-use-storage="{{ can_use_home_storage|yesno:'true,false' }}">


        <!-- Экипировка -->
        <div class="inventory-section" data-tab-label="Экипировка">
            <h2>Экипировка</h2>
            <table class="item-table" id="equip-table">
                <thead>
                <tr>
                    <th>Слот</th>
                    <th>Действия</th>
                    <th>Предмет</th>
                    <th>Действия</th>
                    <th>Бонус</th>
                    <th>Вес</th>
                </tr>
                </thead>
                <tbody>
                {% for slot_dict in slot_names %}
                    {% for slot,label in slot_dict.items %}
                        {% with item=equipment|get_attr:slot %}
                            <tr class="equip-row"
                                data-slot="{{ slot }}"
                                data-label="{{ label }}"
                                    {% if item %}
                                data-unequip-url="{% url 'characters:unequip-slot' char.id slot %}"
                                    {% endif %}>
                                <td>{{ label }}</td>
                                {% if item %}
                                    <td class="td-buttons">
                                        <form class="unequip-form">
                                            {% csrf_token %}
                                            <button class="btn-inventory btn-unequip">Снять</button>
                                        </form>
                                    </td>
                                    <td>{{ item.name }}</td>
                                    <td>+{{ item.bonus }}</td>
                                    <td>{{ item.weight }} кг</td>
                                {% else %}
                                    <td class="td-buttons"></td>
                                    <td colspan="3" class="empty-slot">Пусто</td>
                                {% endif %}
                            </tr>
                        {% endwith %}
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Инвентарь -->
        <div class="inventory-section" data-tab-label="Инвентарь">
            <h2>Инвентарь</h2>
            <table class="item-table" id="inv-table">
                <thead>
                <tr>
                    <th>Название</th>
                    <th>Действия</th>
                    <th>Кол-во</th>
                    <th>Бонус</th>
                    <th>Вес</th>
                    <th>Легендарный бaф</th>
                </tr>
                </thead>
                <tbody>
                {% for entry in inventory_items %}
                    <tr class="inv-row"
                        data-item-id="{{ entry.item.id }}">
                        <td class="name-cell"><span
                                style="border-left: 6px solid {{ entry.item.rarity.color }}; padding-left: 6px">{{ entry.item.name }}</span>
                        </td>
                        <td class="td-buttons">
                            {% if char.can_trade %}
                                <button
                                        class="btn-inventory btn-sell"
                                        data-sell-url="{% url 'shops:ajax-sell-item' char.id entry.item.id %}">
                                    Продать ({{ entry.item|sell_price_for:char }}Ꞩ)
                                </button>
                            {% endif %}
                            <form class="equip-form">
                                {% csrf_token %}
                                <button class="btn-inventory btn-equip">Экипировать</button>
                            </form>
                            <form class="drop-form">
                                {% csrf_token %}
                                <button class="btn-inventory btn-drop">Выбросить</button>
                            </form>
                            {% if can_use_home_storage %}
                                <form class="storage-form" method="post" data-storage-action="store"
                                      data-item-id="{{ entry.item.id }}"
                                      action="{% url 'characters:home-storage-store' char.id entry.item.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-inventory btn-store">В хранилище</button>
                                </form>
                            {% endif %}
                        </td>
                        <td class="quantity-cell">{{ entry.quantity }}</td>
                        <td class="bonus-cell">+{{ entry.item.bonus }}</td>
                        <td class="weight-cell">{{ entry.item.weight }} кг</td>
                        <td class="legendary-cell">
                            {% if entry.item.legendary_buff %}{{ entry.item.legendary_buff }}{% else %}—{% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="empty-slot">Инвентарь пуст.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% if home_storage_enabled %}
            <div class="inventory-section home-storage" data-tab-label="Хранилище">
                <h2>Домашнее хранилище</h2>
                    <table class="item-table home-storage-table">   {# добавлен класс home-storage-table #}
                        <thead>
                        <tr>
                            <th>Название</th>
                            <th>Действия</th>
                            <th>Кол-во</th>
                            <th>Бонус</th>
                            <th>Вес</th>
                            <th>Легендарный баф</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for entry in home_storage_items %}
                            <tr class="storage-row" data-item-id="{{ entry.item.id }}">
                                <td class="name-cell"><span
                                        style="border-left: 6px solid {{ entry.item.rarity.color }}; padding-left: 6px">{{ entry.item.name }}</span>
                                </td>
                                <td class="td-buttons">
                                    {% if can_use_home_storage %}
                                        <form class="storage-form"
                                              method="post"
                                              data-storage-action="retrieve"
                                              data-item-id="{{ entry.item.id }}"
                                              action="{% url 'characters:home-storage-retrieve' char.id entry.item.id %}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn-inventory btn-store">Забрать</button>
                                        </form>
                                    {% else %}
                                        <span class="text-muted">Недоступно</span>
                                    {% endif %}
                                </td>
                                <td class="quantity-cell">{{ entry.quantity }}</td>
                                <td class="bonus-cell">+{{ entry.item.bonus }}</td>
                                <td class="weight-cell">{{ entry.item.weight }} кг</td>
                                <td class="legendary-cell">
                                    {% if entry.item.legendary_buff %}{{ entry.item.legendary_buff }}{% else %}—{% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>

                        {% endfor %}
                        </tbody>
                    </table>


                {# Шаблон строки для динамического добавления в хранилище #}
                <template id="storage-row-template">
                    <tr class="storage-row" data-item-id="">
                        <td class="name-cell"><span></span></td>
                        <td class="td-buttons">
                            <form class="storage-form"
                                  method="post"
                                  data-storage-action="retrieve"
                                  data-item-id="">
                                {% csrf_token %}
                                <button type="submit" class="btn-inventory btn-store">Забрать</button>
                            </form>
                        </td>
                        <td class="quantity-cell">0</td>
                        <td class="bonus-cell">+0</td>
                        <td class="weight-cell">0 кг</td>
                        <td class="legendary-cell">—</td>
                    </tr>
                </template>
            </div>
        {% endif %}
    </div>

    {# Шаблон строки для динамического добавления в инвентарь #}
    <template id="inv-row-template">
        <tr class="inv-row" data-item-id="">
            <td class="name-cell"></td>
            <td class="td-buttons">
                {% if char.can_trade %}
                    <button class="btn-inventory btn-sell" data-sell-url=""></button>
                {% endif %}
                <form class="equip-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <button class="btn-inventory btn-equip">Экипировать</button>
                </form>
                <form class="drop-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <button class="btn-inventory btn-drop">Выбросить</button>
                </form>
                {% if can_use_home_storage %}
                    <form class="storage-form" method="post" data-storage-action="store" data-item-id="" action="">
                        {% csrf_token %}
                        <input type="hidden" name="quantity" value="1">
                        <button type="submit" class="btn-inventory btn-store">В хранилище</button>
                    </form>
                {% endif %}
            </td>
            <td class="quantity-cell"></td>
            <td class="bonus-cell"></td>
            <td class="weight-cell"></td>
            <td class="legendary-cell"></td>
        </tr>
    </template>
    <div class="home-storage-controls">
        {% if can_toggle_home_storage %}
            <form method="post" action="{% url 'characters:home-storage-toggle' char.id %}">
                {% csrf_token %}
                {% if home_storage_enabled %}
                    <button class="btn">Отключить домашнее хранилище</button>
                {% else %}
                    <button class="btn">Разрешить домашнее хранилище</button>
                {% endif %}
            </form>
        {% endif %}
    </div>
    <br>

    {% if not home_storage_enabled and can_toggle_home_storage %}
        <p class="text-muted">Домашнее хранилище сейчас отключено.</p>
    {% endif %}
    <h2>Сундуки</h2>
    {% if char.chests.exists %}
        {% for chest in char.chests.all %}
            <div class="card">
                <h4>{{ chest.config.name }} <small>от {{ chest.created_at|date:"SHORT_DATETIME_FORMAT" }}</small></h4>
                <a href="{% url 'characters:chest-detail' chest.id %}" class="btn">Подробнее <img
                        src="{% static 'img/arrow-right.svg' %}"></a>
            </div>
        {% endfor %}
    {% else %}
        <p>У вас нет текущих сундуков.</p>
    {% endif %}

{% endblock %}

{% block js %}
    <script src="{% static 'js/character_inventory.js' %}"></script>
{% endblock %}