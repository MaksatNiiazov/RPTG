{# templates/characters/character_inventory.html #}
{% extends "base.html" %}
{% load inventory_tags %}

{% block title %}Инвентарь персонажа: {{ char.name }}{% endblock %}

{% block content %}
<h1>Инвентарь персонажа: {{ char.name }}</h1>

<div class="inventory-layout"
     data-char-id="{{ char.id }}"
     data-equip-base="{% url 'characters:equip-item' char.id 0 %}"
     data-drop-base="{% url 'characters:drop-item' char.id 0 %}"
     data-unequip-base="/characters/{{ char.id }}/unequip/">

  <!-- Экипировка -->
  <div class="inventory-section">
    <h2>Экипировка</h2>
    <table class="item-table" id="equip-table">
      <thead>
        <tr>
          <th>Слот</th><th>Предмет</th><th>Бонус</th><th>Вес</th><th></th>
        </tr>
      </thead>
      <tbody>
      {% for slot_dict in slot_names %}
        {% for slot,label in slot_dict.items %}
          {% with item=equipment|get_attr:slot %}
            <tr class="equip-row"
                data-slot="{{ slot }}"
                data-label="{{ label }}"
                {% if item %}
                  data-unequip-url="{% url 'characters:unequip-slot' char.id slot %}"
                {% endif %}>
              <td>{{ label }}</td>
              {% if item %}
                <td>{{ item.name }}</td>
                <td>+{{ item.bonus }}</td>
                <td>{{ item.weight }} кг</td>
                <td>
                  <form class="unequip-form">
                    {% csrf_token %}
                    <button class="btn-inventory btn-unequip">Снять</button>
                  </form>
                </td>
              {% else %}
                <td colspan="4" class="empty-slot">Пусто</td>
              {% endif %}
            </tr>
          {% endwith %}
        {% endfor %}
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Инвентарь -->
  <div class="inventory-section">
    <h2>Инвентарь</h2>
    <table class="item-table" id="inv-table">
      <thead>
        <tr>
          <th>Название</th><th>Кол-во</th><th>Бонус</th><th>Вес</th><th>Легендарный буфф</th><th>Действия</th>
        </tr>
      </thead>
      <tbody>
      {% for entry in inventory_items %}
        <tr class="inv-row"
            data-item-id="{{ entry.item.id }}">
          <td class="name-cell">{{ entry.item.name }}</td>
          <td class="quantity-cell">{{ entry.quantity }}</td>
          <td class="bonus-cell">+{{ entry.item.bonus }}</td>
          <td class="weight-cell">{{ entry.item.weight }} кг</td>
          <td class="legendary-cell">
            {% if entry.item.legendary_buff %}{{ entry.item.legendary_buff }}{% else %}—{% endif %}
          </td>
          <td class="td-buttons">
            <form class="equip-form">
              {% csrf_token %}
              <button class="btn-inventory btn-equip">Экипировать</button>
            </form>
            <form class="drop-form">
              {% csrf_token %}
              <button class="btn-inventory btn-drop">Выбросить</button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6" class="empty-slot">Инвентарь пуст.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# Шаблон строки для динамического добавления в инвентарь #}
<template id="inv-row-template">
  <tr class="inv-row" data-item-id="" >
    <td class="name-cell"></td>
    <td class="quantity-cell"></td>
    <td class="bonus-cell"></td>
    <td class="weight-cell"></td>
    <td class="legendary-cell"></td>
    <td class="td-buttons">
      <form class="equip-form">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <button class="btn-inventory btn-equip">Экипировать</button>
      </form>
      <form class="drop-form">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <button class="btn-inventory btn-drop">Выбросить</button>
      </form>
    </td>
  </tr>
</template>
{% endblock %}

{% block js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const container    = document.querySelector(".inventory-layout");
  const csrfToken    = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
  const equipBase    = container.dataset.equipBase;  // пример: "/characters/characters/3/equip/0/"
  const dropBase     = container.dataset.dropBase;   // пример: "/characters/characters/3/drop/0/"
  const invTableBody = document.querySelector("#inv-table tbody");

  // Найдём уже существующую строку, у которой есть data-unequip-url,
  // и из неё вырежем суффикс "/<slot>/" — так получим базовый URL.
  let unequipBase = "";
  const sample = container.querySelector("tr.equip-row[data-unequip-url]");
  if (sample) {
    const full = sample.dataset.unequipUrl;           // "/characters/characters/3/unequip/main_hand/"
    unequipBase = full.replace(/[^/]+\/$/, "");      // → "/characters/characters/3/unequip/"
  }

  container.addEventListener("submit", async e => {
    const form = e.target;
    if (!form.matches("form.equip-form, form.unequip-form, form.drop-form")) return;
    e.preventDefault();

    // подтвердим выброс ДО запроса
    if (form.matches(".drop-form")) {
      const row = form.closest("tr.inv-row");
      const name = row.querySelector(".name-cell").textContent;
      if (!confirm(`Вы уверены, что хотите выбросить «${name}»?`)) return;
    }

    // вычисляем URL
    let url, tr;
    if (form.matches(".equip-form")) {
      tr  = form.closest("tr.inv-row");
      url = equipBase.replace(/0\/$/, tr.dataset.itemId + "/");
    }
    else if (form.matches(".unequip-form")) {
      tr  = form.closest("tr.equip-row");
      const slot = tr.dataset.slot;
      url = `${unequipBase}${slot}/`;
    }
    else {  // .drop-form
      tr  = form.closest("tr.inv-row");
      url = dropBase.replace(/0\/$/, tr.dataset.itemId + "/");
    }

    try {
      const res  = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest",
          "Accept": "application/json"
        },
        body: new FormData(form)
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const { status, data } = await res.json();
      if (status !== "ok") {
        const msg = typeof data === "string" ? data : JSON.stringify(data);
        return alert("Ошибка: " + data.message);
      }

      // ===== Экипировать =====
      if (form.matches(".equip-form")) {
        const { slot, item } = data;
        const eqRow = container.querySelector(`tr.equip-row[data-slot="${slot}"]`);
        eqRow.innerHTML = `
          <td>${eqRow.dataset.label}</td>
          <td>${item.name}</td>
          <td>+${item.bonus}</td>
          <td>${item.weight} кг</td>
          <td>
            <form class="unequip-form">
              <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
              <button class="btn-inventory btn-unequip">Снять</button>
            </form>
          </td>`;
        // Восстанавливаем правильный URL для снятия:
        eqRow.dataset.unequipUrl = `${unequipBase}${slot}/`;

        // Убавляем или удаляем из инвентаря
        const invRow = container.querySelector(`tr.inv-row[data-item-id="${item.id}"]`);
        if (invRow) {
          const cell = invRow.querySelector(".quantity-cell");
          let q = parseInt(cell.textContent, 10) - 1;
          if (q > 0) cell.textContent = q;
          else invRow.remove();
        }
      }

      // ===== Снять =====
      else if (form.matches(".unequip-form")) {
        const { slot, item } = data;
        // Очищаем карточку
        const eqRow = container.querySelector(`tr.equip-row[data-slot="${slot}"]`);
        eqRow.innerHTML = `
          <td>${eqRow.dataset.label}</td>
          <td colspan="4" class="empty-slot">Пусто</td>`;

        // Добавляем в инвентарь
        let invRow = invTableBody.querySelector(`tr.inv-row[data-item-id="${item.id}"]`);
        if (invRow) {
          invRow.querySelector(".quantity-cell").textContent =
            parseInt(invRow.querySelector(".quantity-cell").textContent, 10) + 1;
        } else {
          const tpl    = document.getElementById("inv-row-template");
          const clone  = tpl.content.cloneNode(true);
          const newRow = clone.querySelector("tr");
          newRow.dataset.itemId = item.id;
          newRow.querySelector(".name-cell").textContent      = item.name;
          newRow.querySelector(".quantity-cell").textContent  = 1;
          newRow.querySelector(".bonus-cell").textContent     = "+" + item.bonus;
          newRow.querySelector(".weight-cell").textContent    = item.weight + " кг";
          newRow.querySelector(".legendary-cell").textContent = item.legendary_buff || "—";
          invTableBody.append(newRow);
        }
      }

      // ===== Выбросить =====
      else {
        const { item_id, remaining } = data;
        const invRow = container.querySelector(`tr.inv-row[data-item-id="${item_id}"]`);
        if (!invRow) return;
        if (remaining > 0) {
          invRow.querySelector(".quantity-cell").textContent = remaining;
        } else {
          invRow.remove();
        }
      }
    }
    catch(err) {
      console.error(err);
      alert("Не удалось: " + err.message);
    }
  });
});
</script>
{% endblock %}

