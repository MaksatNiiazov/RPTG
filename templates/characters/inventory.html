{# templates/characters/character_inventory.html #}
{% extends "base.html" %}
{% load inventory_tags %}

{% block title %}Инвентарь персонажа: {{ char.name }}{% endblock %}

{% block content %}
    <h1>Инвентарь персонажа: {{ char.name }}</h1>

    <div class="inventory-layout">

        <!-- Экипировка -->
        <div class="inventory-section">
            <h2>Экипировка</h2>
            <table class="item-table" id="equip-table">
                <thead>
                <tr>
                    <th>Слот</th>
                    <th>Предмет</th>
                    <th>Бонус</th>
                    <th>Вес</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for slot_dict in slot_names %}
                    {% for slot,label in slot_dict.items %}
                        {% with item=equipment|get_attr:slot %}
                            <tr class="equip-row"
                                data-slot="{{ slot }}"
                                data-label="{{ label }}">
                                <td>{{ label }}</td>
                                {% if item %}
                                    <td>{{ item.name }}</td>
                                    <td>+{{ item.bonus }}</td>
                                    <td>{{ item.weight }} кг</td>
                                    <td>
                                        <form class="unequip-form"
                                              method="post"
                                              action="{% url 'characters:unequip-slot' char.id slot %}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn-inventory btn-unequip">
                                                Снять
                                            </button>
                                        </form>
                                    </td>
                                {% else %}
                                    <td colspan="4" class="empty-slot">Пусто</td>
                                {% endif %}
                            </tr>
                        {% endwith %}
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Инвентарь -->
        <div class="inventory-section">
            <h2>Инвентарь</h2>
            <table class="item-table" id="inv-table">
                <thead>
                <tr>
                    <th>Название</th>
                    <th>Кол-во</th>
                    <th>Бонус</th>
                    <th>Вес</th>
                    <th>Легендарный бонус</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                {% for entry in inventory_items %}
                    <tr class="inv-row" data-item-id="{{ entry.item.id }}">
                        <td>{{ entry.item.name }}</td>
                        <td class="quantity-cell">{{ entry.quantity }}</td>
                        <td>+{{ entry.item.bonus }}</td>
                        <td>{{ entry.item.weight }} кг</td>
                        <td>
                            {% if entry.item.legendary_buff %}
                                {{ entry.item.legendary_buff }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="td-buttons">
                            <form class="equip-form"
                                  method="post"
                                  action="{% url 'characters:equip-item' char.id entry.item.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn-inventory btn-equip">
                                    Экипировать
                                </button>
                            </form>
                            <form class="drop-form"
                                  method="post"
                                  action="{% url 'characters:drop-item' char.id entry.item.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn-inventory btn-drop">
                                    Выбросить
                                </button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="empty-slot">Инвентарь пуст.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
{% endblock %}

{% block js %}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const charId = "{{ char.id }}";

            function bindAjax(selector, onSuccess) {
                document.querySelectorAll(selector).forEach(form => {
                    form.addEventListener("submit", e => {
                        e.preventDefault();
                        fetch(form.action, {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": csrfToken,
                                "X-Requested-With": "XMLHttpRequest",
                                "Accept": "application/json"
                            },
                            body: new FormData(form)
                        })
                            .then(response => {
                                if (!response.ok) throw new Error("HTTP " + response.status);
                                return response.json();
                            })
                            .then(json => {
                                if (json.status === "ok") {
                                    onSuccess(json.data);
                                } else {
                                    alert("Ошибка: " + json.message);
                                }
                            })
                            .catch(err => {
                                console.error("AJAX error:", err);
                                alert("Не удалось выполнить операцию: " + err.message);
                            });
                    });
                });
            }

// 1) Экипировка
            bindAjax(".equip-form", ({slot, item}) => {
                // — Обновляем строку в таблице «Экипировка»
                const row = document.querySelector(`tr.equip-row[data-slot="${slot}"]`);
                if (row) {
                    row.innerHTML = `
      <td>${row.dataset.label}</td>
      <td>${item.name}</td>
      <td>+${item.bonus}</td>
      <td>${item.weight} кг</td>
      <td>
        <form class="unequip-form" method="post"
              action="/characters/${charId}/unequip/${slot}/">
          <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
          <button type="submit" class="btn-inventory btn-unequip">Снять</button>
        </form>
      </td>`;
                    bindAjax(".unequip-form", onUnequip);
                }

                // — Обновляем таблицу «Инвентарь»
                const invTableBody = document
                    .getElementById("inv-table")
                    .querySelector("tbody");
                // найдём строку с этим предметом
                const invRow = invTableBody.querySelector(
                    `tr.inv-row[data-item-id="${item.id}"]`
                );
                if (invRow) {
                    const qtyCell = invRow.querySelector(".quantity-cell");
                    let qty = parseInt(qtyCell.textContent, 10) - 1;
                    if (qty > 0) {
                        qtyCell.textContent = qty;
                    } else {
                        // если больше не осталось — удаляем строку
                        invRow.remove();
                    }
                }
            });


            // 2) Снятие
            function onUnequip({slot, item}) {
                // Очистить слот
                const row = document.querySelector(`tr.equip-row[data-slot="${slot}"]`);
                if (row) {
                    row.innerHTML = `
        <td>${row.dataset.label}</td>
        <td colspan="4" class="empty-slot">Пусто</td>`;
                }
                // Вернуть в инвентарь
                const invTable = document.getElementById("inv-table").querySelector("tbody");
                let invRow = invTable.querySelector(`tr.inv-row[data-item-id="${item.id}"]`);
                if (invRow) {
                    invRow.querySelector(".quantity-cell").textContent =
                        parseInt(invRow.querySelector(".quantity-cell").textContent) + 1;
                } else {
                    const tr = document.createElement("tr");
                    tr.className = "inv-row";
                    tr.dataset.itemId = item.id;
                    tr.innerHTML = `
        <td>${item.name}</td>
        <td class="quantity-cell">1</td>
        <td>+${item.bonus}</td>
        <td>${item.weight} кг</td>
        <td>—</td>
        <td class="td-buttons">
          <form class="equip-form" method="post"
                action="/characters/${charId}/equip/${item.id}/">
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
            <button type="submit" class="btn-inventory btn-equip">Экипировать</button>
          </form>
          <form class="drop-form" method="post"
                action="/characters/${charId}/drop/${item.id}/">
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
            <button type="submit" class="btn-inventory btn-drop">Выбросить</button>
          </form>
        </td>`;
                    invTable.append(tr);
                    bindAjax(".equip-form", () => {
                    });
                    bindAjax(".drop-form", onDrop);
                }
            }

            bindAjax(".unequip-form", onUnequip);

            // 3) Выбросить
            function onDrop({item_id, remaining}) {
                const row = document.querySelector(`tr.inv-row[data-item-id="${item_id}"]`);
                if (!row) return;
                if (remaining > 0) {
                    row.querySelector(".quantity-cell").textContent = remaining;
                } else {
                    row.remove();
                }
            }

            bindAjax(".drop-form", onDrop);

        });
    </script>
{% endblock %}
